---
/**
 * Auth Callback Handler
 *
 * Handles OAuth callbacks and PKCE flow redirects from Supabase Auth.
 * This includes email confirmation and password reset flows.
 */

// Get the code and next parameters from URL
const code = Astro.url.searchParams.get("code");
const next = Astro.url.searchParams.get("next") || "/";

// If there's a code, exchange it for a session
if (code) {
  const { error } = await Astro.locals.supabase.auth.exchangeCodeForSession(code);

  if (error) {
    // If exchange fails, redirect to login with error
    return Astro.redirect(`/login?error=${encodeURIComponent(error.message)}`);
  }
}

// Get the user to determine redirect
const {
  data: { user },
} = await Astro.locals.supabase.auth.getUser();

if (user) {
  // Check if this is a password update flow
  if (next === "/update-password") {
    return Astro.redirect("/update-password");
  }

  // Redirect to home page (dashboard)
  return Astro.redirect("/");
}

// Default redirect
return Astro.redirect(next);
---
