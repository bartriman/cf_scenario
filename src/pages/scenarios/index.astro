---
import Layout from "@/layouts/Layout.astro";
import { ScenarioListContainer } from "@/components/scenario/ScenarioListContainer";

export const prerender = false;

// Check authentication
const supabase = Astro.locals.supabase;
const {
  data: { user },
  error: authError,
} = await supabase.auth.getUser();

// Redirect to login if not authenticated
if (authError || !user) {
  return Astro.redirect(`/auth/login?redirect=${encodeURIComponent("/scenarios")}`);
}

// Get user's default company
const { data: profile, error: profileError } = await supabase
  .from("user_profiles")
  .select("default_company_id")
  .eq("user_id", user.id)
  .single();

if (profileError || !profile?.default_company_id) {
  return new Response("Company not found. Please set up your company profile.", { status: 404 });
}

const companyId = profile.default_company_id;

// Optional: Server-side fetch of scenarios for SSR
let initialScenarios = [];
try {
  const { data: scenarios, error: scenariosError } = await supabase
    .from("scenarios")
    .select(
      `
      id,
      company_id,
      import_id,
      dataset_code,
      name,
      status,
      base_scenario_id,
      start_date,
      end_date,
      locked_at,
      locked_by,
      created_at
    `
    )
    .eq("company_id", companyId)
    .is("deleted_at", null)
    .order("created_at", { ascending: false });

  if (!scenariosError && scenarios) {
    initialScenarios = scenarios;
  }
} catch (error) {
  console.error("Error fetching scenarios:", error);
  // Continue with empty array - component will fetch client-side
}
---

<Layout title="Moje scenariusze - CashFlow Scenarios">
  <main class="min-h-screen bg-background">
    <ScenarioListContainer client:load companyId={companyId} initialScenarios={initialScenarios} />
  </main>
</Layout>
