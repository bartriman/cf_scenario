---
import Layout from "../layouts/Layout.astro";
import type { UserProfileResponseDTO } from "../types";
import { LoginForm } from "../components/auth/LoginForm";

// Sprawdzenie czy użytkownik jest już zalogowany
const {
  data: { user },
} = await Astro.locals.supabase.auth.getUser();

if (user) {
  // Użytkownik zalogowany - sprawdź profil i przekieruj
  try {
    const profileResponse = await fetch(`${Astro.url.origin}/api/profile`, {
      headers: {
        Authorization: `Bearer ${(await Astro.locals.supabase.auth.getSession()).data.session?.access_token}`,
      },
    });

    if (profileResponse.ok) {
      const profile: UserProfileResponseDTO = await profileResponse.json();

      if (profile.default_company_id) {
        return Astro.redirect(`/companies/${profile.default_company_id}/dashboard`);
      } else if (profile.companies.length > 0) {
        return Astro.redirect(`/companies/${profile.companies[0].company_id}/dashboard`);
      }
    }
  } catch {
    // Ignore error and show login form
  }
}
---

<Layout title="Zaloguj się - CashFlow Scenarios">
  <div class="flex min-h-screen items-center justify-center bg-gray-50 px-4 py-12 sm:px-6 lg:px-8">
    <div class="w-full max-w-md">
      <div class="mb-8 text-center">
        <h1 class="text-3xl font-bold tracking-tight text-gray-900">CashFlow Scenarios</h1>
        <p class="mt-2 text-sm text-gray-600">Zaloguj się do swojego konta</p>
      </div>

      <LoginForm client:only="react" />
    </div>
  </div>
</Layout>
