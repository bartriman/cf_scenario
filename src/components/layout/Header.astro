---
import DemoBanner from "@/components/auth/DemoBanner.astro";

interface Props {
  isAuthenticated?: boolean;
  userEmail?: string;
}

const { isAuthenticated = false, userEmail } = Astro.props;
---

<header class="border-b bg-white dark:bg-gray-950">
  <!-- Demo banner for non-authenticated users -->
  {!isAuthenticated && <DemoBanner />}

  <div class="container mx-auto px-4 py-4">
    <div class="flex items-center justify-between">
      <!-- Logo and app name -->
      <a href="/" class="flex items-center gap-2 hover:opacity-80 transition-opacity">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-8 w-8 text-primary"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          ></path>
        </svg>
        <span class="text-xl font-semibold text-gray-900 dark:text-gray-100">
          CashFlow Scenarios
        </span>
      </a>

      <!-- Navigation -->
      <nav class="flex items-center gap-4">
        {
          !isAuthenticated ? (
            // Non-authenticated state: Show login and register buttons
            <div class="flex items-center gap-3">
              <a
                href="/auth/login"
                class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-gray-100 transition-colors"
              >
                Zaloguj się
              </a>
              <a
                href="/auth/register"
                class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-primary/90 transition-colors shadow-sm"
              >
                Zarejestruj się
              </a>
            </div>
          ) : (
            // Authenticated state: Show user menu
            <div class="relative" id="user-menu-container">
              <button
                id="user-menu-button"
                class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-md transition-colors"
                aria-expanded="false"
                aria-haspopup="true"
              >
                <div class="h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center">
                  <span class="text-primary font-semibold text-sm">
                    {userEmail ? userEmail.charAt(0).toUpperCase() : "U"}
                  </span>
                </div>
                <span class="hidden sm:inline">{userEmail}</span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  />
                </svg>
              </button>

              {/* Dropdown menu */}
              <div
                id="user-menu-dropdown"
                class="absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 hidden z-50"
                role="menu"
                aria-orientation="vertical"
                aria-labelledby="user-menu-button"
              >
                <div class="py-1">
                  <div class="px-4 py-2 text-sm text-gray-700 dark:text-gray-300 border-b dark:border-gray-700">
                    <p class="font-medium">Zalogowany jako</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 truncate">
                      {userEmail}
                    </p>
                  </div>
                  <a
                    href="/account"
                    class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                    role="menuitem"
                  >
                    <div class="flex items-center gap-2">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                        />
                      </svg>
                      Moje konto
                    </div>
                  </a>
                  <button
                    id="logout-button"
                    class="w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    role="menuitem"
                  >
                    <div class="flex items-center gap-2">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-4 w-4"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
                        />
                      </svg>
                      <span id="logout-text">Wyloguj się</span>
                    </div>
                  </button>
                </div>
              </div>
            </div>
          )
        }
      </nav>
    </div>
  </div>
</header>

{isAuthenticated && (
  <script>
    // User menu toggle functionality
    const menuButton = document.getElementById("user-menu-button");
    const menuDropdown = document.getElementById("user-menu-dropdown");
    const menuContainer = document.getElementById("user-menu-container");

    if (menuButton && menuDropdown && menuContainer) {
      // Toggle menu on button click
      menuButton.addEventListener("click", (e) => {
        e.stopPropagation();
        const isExpanded = menuButton.getAttribute("aria-expanded") === "true";
        menuButton.setAttribute("aria-expanded", String(!isExpanded));
        menuDropdown.classList.toggle("hidden");
      });

      // Close menu when clicking outside
      document.addEventListener("click", (e) => {
        const target = e.target;
        if (target instanceof Node && !menuContainer.contains(target)) {
          menuButton.setAttribute("aria-expanded", "false");
          menuDropdown.classList.add("hidden");
        }
      });

      // Close menu on Escape key
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && menuButton.getAttribute("aria-expanded") === "true") {
          menuButton.setAttribute("aria-expanded", "false");
          menuDropdown.classList.add("hidden");
          menuButton.focus();
        }
      });

      // Handle logout
      const logoutButton = document.getElementById("logout-button");
      const logoutText = document.getElementById("logout-text");
      
      if (logoutButton && logoutText) {
        logoutButton.addEventListener("click", async () => {
          // Disable button and update text
          logoutButton.setAttribute("disabled", "true");
          const originalText = logoutText.textContent;
          logoutText.textContent = "Wylogowywanie...";
          
          try {
            const response = await fetch("/api/auth/logout", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            });

            if (response.ok) {
              // Redirect to home page after successful logout
              window.location.href = "/";
            } else {
              // Re-enable button and restore text if logout failed
              logoutButton.removeAttribute("disabled");
              logoutText.textContent = originalText || "Wyloguj się";
              console.error("Logout failed");
            }
          } catch (error) {
            // Re-enable button and restore text on error
            logoutButton.removeAttribute("disabled");
            logoutText.textContent = originalText || "Wyloguj się";
            console.error("Logout error:", error);
          }
        });
      }
    }
  </script>
)}
